Зеркалирование портов в Hyper-V
Зеркалирование портов можно использовать в системах на базе Hyper-V для поиска неисправностей в сети, тестирования, мониторинга, анализа сетевого трафика и перенаправления трафика на анализ в IDS системы (системы обнаружения вторжений
Set-VMNetworkAdapter –VMName VMWin2008Source –PortMirroring Source

Set-VMNetworkAdapter –VMName VMWin2008Monitor –PortMirroring Destination
**************
Как увеличить/уменьшить размер виртуального диска Hyper-V
•	Вы можете изменить размер виртуального диска Hyper-V любого типа: фиксированного, динамического, и дифференциального.
•	Вы можете изменить размер VHDX диска (в том числе системного диска гостевой ОС) на-лету. Останавливатьвиртуальную машину не нужно;
•	VHDX диск должен быть подключен к ВМ через виртуальный SCSI контролер (не поддерживается онлайн расширение дисков на IDE контроллере, такую ВМ придется выключить для изменения размера диска);
•	Online VHDX Resize работает как на первом, так и втором поколении виртуальных машин Hyper-V;
•	В качестве гостевой ОС может выступать, как Windows, так и Linux;
•	Поддерживается как расширение виртуальных дисков (extend), так и их сжатие (shrink);
•	Вы можете изменить размер vhdx диска из графической консоли Hyper-V, PowerShell или Windows Admin Center;
•	Не поддерживается изменение размера общих VHDX файлов или VHD Set (VHDS/AVHDX) дисков, используемых в гостевых кластерах;
•	Нельзя изменить размер виртуального диска, для которого создан снапшот (например при резервном копировании).
Get-VM -VMName fs01 | Select-Object VMId | Get-VHD
Resize-VHD -Path 'C:\VM\fs01\Virtual Hard Disks\fs01.vhdx' -SizeBytes 50Gb
Enter-PSSession -ComputerName fs01
$MaxSize = (Get-PartitionSupportedSize -DriveLetter C).SizeMax
Resize-Partition -DriveLetter L -Size $MaxSize
************
Списки контроля доступа порта в Hyper-V
Стандартные ACL появились в 3 версии гипервизора в Windows Server 2012. С их помощью можно для каждого порта виртуального коммутатора настроить одно или несколько правил, ограничив доступ к виртуальной машине по IP или MAC-адресу.
Настройки ACL производятся исключительно с помощью PowerShell, управление списками через Hyper-V Manager невозможно. Для создания правила используется командлет Add-VMNetworkAdapterAcl, в качестве объекта применения правила можно указать виртуальную машину, либо, если у машины несколько сетевых интерфейсов, то можно выбрать конкретный виртуальный адаптер. Для каждого списка требуется указать:
• Локальный или удаленный IPv4 или IPV6-адрес. Допускается указывать подсеть, например 192.168.1.0/24 или f001:f002:f003:f004::1/64. Для запрета всего IPv4 трафика можно указать 0.0.0.0/0, для запрета всего IPV6 — ::/0, а указав ANY, мы запрещаем любой трафик;
• Локальный или удаленный MAC-адрес, например 00-ab-00-11-22-33. Также можно использовать символ *(wildcard) либо ANY для указания всех MAC-адресов;
• Направление трафика, подпадающего под правило — входящий (Inbound), исходящий (Outbound), в обе стороны (Both);
• Действие — разрешить (Allow), запретить (Deny), измерить (Meter).
Примечание. Действие Meter не является запрещающим или разрешающим, оно служит исключительно для измерения объема трафика для конкретного IP-адреса. Трафик считается с момента создания правила.
Для примера запретим  для виртуальной машины srv3 весь трафик:
Add-VMNetworkAdapterAcl -VMName srv3 -RemoteIPAddress ANY -Direction Both -Action Deny
И проверим получившееся правило командой:
Get-VMNetworkAdapterAcl
Начиная с Windows Server 2012 R2 для управления трафиком в Hyper-V можно использовать расширенные списки доступа (Extended Port ACL). Также как и обычные ACL, их можно применять к виртуальным машинам или отдельным виртуальным сетевым адаптерам, подключенным к виртуальному коммутатору Hyper-V. Однако расширенные ACL имеют большее количество параметров, чем обычные, что дает возможность создавать более подробные правила.
Так расширенные ACL позволяют не просто разрешать или запрещать весь трафик, но и указывать конкретные протоколы и порты. При создании правила с использованием расширенных ACL можно указывать следующий набор параметров:
• Локальный или удаленный IPv4 или IPV6-адрес. Формат записи такой же, как и для стандартных правил;
• Сетевой протокол. Протокол можно указывать как в текстовом виде, напр. TCP или UDP, так и в цифровом, напр. 0x01 (ICMP) или 0x02 (IGMP). Список кодов можно посмотреть здесь;
• Локальный или удаленный порт;
• Направление трафика, подпадающего под правило — входящий (Inbound) или исходящий (Outbound);
• Действие — разрешить (Allow), запретить (Deny);
• Удельный вес правила (Weight), который определяет порядок обработки правил. Правила с более высокими значениями обрабатываются раньше, чем с более низкими. Например, правило с весом 10 будет обработано раньше, чем правило с весом 1.
Создание и управление расширенными ACL также возможно только из консоли PowerShell. Для создания правила используется командлет Add-VMNetworkAdapterExtendedAcl, для просмотра  Get-VMNetworkAdapterExtendedAcl и Remove-VMNetworkAdapterExtendedAcl для удаления.
В качестве примера создадим два правила, в первом для srv3 запретим весь входящий трафик, а во втором разрешим входящие подключения только на порт 3389 (RDP):
Add-VMNetworkAdapterExtendedAcl -VMName srv3 -Direction Inbound -Action Deny -Weight 1
Add-VMNetworkAdapterExtendedAcl -VMName srv3 -Direction Inbound  -LocalPort ″3389″ -Protocol ″TCP″ -Action Allow -Weight 2

Get-VMNetworkAdapterExtendedAcl -VMName srv2 | ft direction,action,*address,*port,protocol,stateful,*timeout -auto
********
Мониторинг загрузки процессора на серверах Hyper-V
Для мониторинга загрузки процессора в Hyper-V есть три группы счетчиков:
• Hyper-V Hypervisor Logical Processor;
• Hyper-V Hypervisor Virtual Processor;
• Hyper-V Hypervisor Root Virtual Processor.
Это основная группа счетчиков Hyper-V, которая показывает нагрузку на процессор в привязке к логическим процессорам. Напомню, что под логическим процессором система понимает физические ядра процессора или вычислительные потоки (при использовании Hyper-Threading).
Hyper-V Hypervisor Logical Processor позволяет выводить как общую нагрузку (_Total), так и по каждому логическому процессору (LP) отдельно. Основные счетчики для мониторинга общей нагрузки, это:
% Guest Run Time — нагрузка на процессор, создаваемая виртуальными машинами;
% Hypervisor Run Time — нагрузка на процессор, создаваемая самим гипервизором, т.е. процент процессорного времени, которое затрачено гипервизором на обслуживание виртуальных машин;
% Total Run Time — общая нагрузка на процессор, представляет из себя сумму двух предыдущих счетчиков.
yper-V Hypervisor Virtual Processor показывает нагрузку на процессор, создаваемую виртуальными машинами. Виртуальные процессоры (VP) группируются по принадлежности к виртуальным машинам, что позволяет оценить нагрузку, создаваемую каждой отдельной машиной, а общее значение (_Total) показывает суммарную нагрузку, создаваемую гостевыми ОС.
Виртуальные процессоры имеют большое количество различных счетчиков, но основные те же, что и в предыдущем случае:
% Guest Run Time — процент процессорного времени, затраченный виртуальными машинами на собственные задачи, не связанные с гипервизором;
% Hypervisor Run Time — процент процессорного времени, затраченный виртуальными машинами на задачи, связанные с гипервизором;
% Total Run Time — общая нагрузка на процессор, создаваемая виртуальными машинами. Представляет из себя сумму двух предыдущих счетчиков.
Hyper-V Hypervisor Root Virtual Processor содержит такой же набор счетчиков, как и Hyper-V Hypervisor Virtual Processor. Отличие их в том, что Hyper-V Hypervisor Root Virtual Processor содержит счетчики только для хостовой ОС, которая работает в основном разделе (Root partition):
% Guest Run Time — процент процессорного времени, затраченный хостом на задачи, не связанные с гипервизором;
% Hypervisor Run Time — процент процессорного времени, затраченный хостовой системой на обслуживание гипервизора;
% Total Run Time — общая нагрузка на процессор, создаваемая хостовой ОС. Представляет из себя сумму предыдущих счетчиков.
**********
Определение Memory overcommit в гостевой виртуальной машине
Memory overcommit (определения на русском я не знаю, пусть будет оверкоммит памяти) это фича гипервизора, которая позволяет выделить виртуальным машинам памяти больше, чем имеется на физическом хосте, однако без гарантии того, что в конкретный момент времени вся запрошенная память может быть выделена. Как правило, overcommit позволяет увеличить плотность размещения виртуальных машин на хосте за счет того, что память будет динамически перераспределятся между ними в зависимости от текущей нагрузки (ресурсы ненагруженных/простаивающих в данный момент ВМ могут быть перераспределены между более загруженными)
Чтобы понять, что происходит с памятью, нужно воспользоваться утилитой RamMap Марка Русиновича (в одних из прошлых кейсов я показывал, как использовать эту утилиту для диагностики проблемы с системным кэшем файловой системы). Качаем утилиту с сайта Microsoft (https://technet.microsoft.com/en-us/library/ff700229.aspx) и запускаем с правами администратора. После этого, на вкладке Use Counts видим, что большая часть памяти (5,4 Гб) используется объектом Driver Locked.
Это и есть та память, которую «отъел» гипервизор и перераспределил другим виртуальным машинам через balloon-драйвер в гостевой ОС. Т.е. на хосте гипервизора не хватает памяти, либо администратор гипервизора принудительно «зарезал» ресурсы для данной ВМ.
Текущий расклад по памяти в ВМ на Hyper-V могут дать счетчики отдельные производительности в Performance Monitor:
•	Hyper-V Dynamic Memory –>Guest Visible Memory
•	Hyper-V Dynamic Memory –> Physical Memory
Чтобы отключить такое поведение, администратор гипервизора должен отключить в настройках ВМ Hyper-V опцию Enable Dynamic Memory (или увеличить значение минимальной резервации).
**********
Включаем поддержку SR-IOV для виртуальных машин Hyper-V
SR-IOV (Single Root Input/Output Virtualization) это технология виртуализации аппаратных устройств хоста, позволяющая предоставить виртуальным машинам прямой доступ к устройствам. Технология позволяет виртуализировать различные виды устройств, но чаще всего используется для виртуализации сетевых адаптеров. В этой статье мы расскажем, как правильно включить и настроить SR-IOV для сетевых адаптеров виртуальных машин на сервере Hyper-V.
Благодаря использованию SR-IOV для виртуальных машин Hyper-V вы существенно увеличите пропускную способность, снизите сетевую задержку и уменьшите нагрузку на CPU, вызванную необходимостью обрабатывать сетевой трафик программными средствами Hyper-V.
SR-IOV не совместима с NIC teaming.
В первую очередь нужно включить поддержку SR-IOV и виртуализации в BIOS вашего сервера. В зависимости от вендора и модели сервера эти настройки могут отличаться.
•	Виртуализация: Intel (Virtualization Technology, Intel VT, VT-d, Vanderpool), AMD (SVM, AMD-V)
•	IOMMU
•	SR-IOV
•	ASPM
(get-vmhost).IovSupport
(get-vmhost).IovSupportReasons

New-VMSwitch -Name "Ext_network" -NetAdapterName "Ethernet 2" -EnableIov 1

Set-VMNetworkAdapter -VMName testvm -VMNetworkAdapterName “Network Adapter” -IovWeight 100
**********

Низкая скорость сети на хосте Hyper-V с Windows Server 2019
В первую очередь нужно вспомнить про технологии Receive Segment Coalescing (RSC), которая появилась в Hyper-V на Windows Server 2019/2022 (и в Windows 10 начиная с билда 1809). Receive Segment Coalescing используется на уровне виртуального коммутатора (vSwitch), позволяет снизить нагрузку на CPU и увеличить пропускную способность сети за счет объединения нескольких TCP сегментов в меньшее количество более крупных сегментов. Увеличение производительности сети достигается за счет того, что несколько больших сегментов обрабатывают быстрее множества мелких.
Проверить, включен ли RSC для виртуальных коммутаторов можно командой:
Get-VMSwitch | Select-Object *RSC*
Можно запретить использовать RSC для IPv4 трафика на уровне клиентского сетевого адаптера:
Disable-NetAdapterRsc -Name "Ethernet" -IPv4
В некоторых случаях наличие включенной опции VMQ (Virtual Machine Queue) в драйвере сетевого адаптера физического хоста Hyper-V может привести к плохой производительности сети в виртуальных машинах Hyper-V. Связано это с тем, что VMQ это аппаратная функция, и, если она не поддерживается железом, но включена в драйвере это вызывает потерю пакетов и увеличивает сетевую задержку. Эта проблема характерна для сетевых карточек Broadcom Gigabit и встречается во всех версиях Hyper-V на Windows 2012 R2/2016/2019. Get-NetAdapterVmq
Чтобы отключить VMQ для определенного адаптера, выполните команду (сетевой адаптер будет недоступен в течении пары секунд):
Set-NetAdapterVmq -Name “NICName” -Enabled $False
Get-NetTCPSetting -SettingName Datacenter,DatacenterCustom,InternetCustom,Internet|select SettingName,CongestionProvider,CwndRestart,ForceWS|Export-csv c:\ps\nettcp_backup.csv

Примените новые настройка для LAN сети:
Set-NetTCPSetting -SettingName DatacenterCustom,Datacenter -CongestionProvider DCTCP
Set-NetTCPSetting -SettingName DatacenterCustom,Datacenter -CwndRestart True
Set-NetTCPSetting -SettingName DatacenterCustom,Datacenter -ForceWS Disabled
Для WAN сети:
Set-NetTCPSetting -SettingName InternetCustom,Internet -CongestionProvider CTCP
Set-NetTCPSetting -SettingName InternetCustom,Internet -DelayedAckTimeoutMs 50
Set-NetTCPSetting -SettingName InternetCustom,Internet -ForceWS Disabled
Отключите методики оптимизации сетевого RSS и RSC на уровне стека TCP:
netsh int tcp show global
netsh int tcp set global RSS=Disabled
netsh int tcp set global RSC=Disabled
или на уровне сетевых адаптеров:
Get-NetAdapter | Set-NetAdapterAdvancedProperty -DisplayName "Recv Segment Coalescing (IPv4)" -DisplayValue "Disabled" -NoRestart
Get-NetAdapter | Set-NetAdapterAdvancedProperty -DisplayName "Recv Segment Coalescing (IPv6)" -DisplayValue "Disabled" -NoRestart
Get-NetAdapter | Set-NetAdapterAdvancedProperty -DisplayName "Receive Side Scaling" -DisplayValue "Disabled" –NoRestart
Отключите vRSS для всех ВМ:
Get-VM | Set-VMNetworkAdapter -VrssEnabled $FALSE
Отключите функцию Large Send Offload (LSO) на сетевых картах:

Get-NetAdapter | Set-NetAdapterAdvancedProperty -DisplayName "Large Send Offload Version 2 (IPv4)" -DisplayValue "Disabled" -NoRestart
Get-NetAdapter | Set-NetAdapterAdvancedProperty -DisplayName "Large Send Offload Version 2 (IPv6)" -DisplayValue "Disabled" -NoRestart
Get-NetAdapter | Restart-NetAdapter
*********
Управление числом vCPU и ядер в виртуальной машине
При назначении ядер на сокете учитывайте наличие NUMA архитектуры (используется в большинстве современных CPU). Не рекомендуется назначать вашей ВМ количество ядер на сокет (и общее количество vCPU) больше, чем доступно ядер на вашем физическом сокете/процессоре (ноде NUMA). При размещении на одной физической ноде NUMA, виртуальная машина сможет использовать быструю локальную RAM, доступную на конкретной ноде NUMA. Иначе для выполнения операции процессам придется ждать ответа от другой ноды NUMA (что несколько более долго).
Если вы назначаете для ВМ два отдельных виртуальных сокета, то гипервизор может их запускать на разных нодах NUMA. Что не лучшим образом скажется на производительности ВМ.
для 2 процессорного хоста с 10 ядрами (суммарно доступно 40 vCPU с учетом Hyper—Threading), при настройке vCPU для ВМ оптимально использовать такие конфигурации:
Требуемое количество vCPU	Количество виртуальных сокетов в настройках ВМ	Количество ядер на виртуальном процессоре в настройках ВМ
1	1	1
……
10	1	10
11	Не оптимально
12	2	6
……
20	2	10
***
Резервное копирование виртуальных машин Hyper-V
сть два подхода к резервному копированию ВМ:
•	Резервное копирование ВМ с хоста Hyper-V (host-level VM backup) – администратор управляет инструментом резевного копирования на уровне всего хоста Hyper-V;
•	Резервное копирование с помощью агента, установленного в гостевой ОС (guest-level VM backup) – используются довольно редко. В основном для приложений, которые не позволяют корректно создать бэкап через VSS.
упрощенно выглядит типовой процесс резервного копирования в Hyper-V:
1.	Средство резервного копирования (СРК) отдает команду хосту Hyper-V на создание снимка ВМ;
2.	Гипервизор создает новые файлы (дельта-файлы) и ВМ продолжает свою работу, сохраняя изменения в этих файлах;
3.	СРК копирует оригинальные файлы ВМ (изменения в них не пишутся) на носитель резервных копий (внешний диск, папку, ленту) и после отдает команду на удаления снапшота ВМ;
4.	Hyper-V удаляет снапшот и производит консолидацию (слияние) исходных и дельта файлов (работа ВМ при этом не прерывается)

1.	Чем дольше средство резервного копирования забирает снапшот (бэкап) к себе, тем больше изменений накапливается в дельта файлах. При большом количестве изменений внутри ВМ за время копирования файлов, процесс слияния файлов при удалении снапшота может вызывать высокую нагрузку на диски, Hyper-V хост и саму ВМ. В Hyper-V Server 2016 для ускорения процесса резервного копирования используется технологий Resilient ChangedTracking, которая позволяет средству резервного копирования копировать только блоки данных, измененные с момент последнего бэкапа. При этом не нужно «забирать» ВМ целиком.
2.	При копировании данных снимка ВМ по LAN сети с хоста Hyper-V на хранилище резервных копий возможно вызвать высокую нагрузку на сеть. Рекомендуется использовать отдельный интерфейс сервера для трафика резервного копирования, или копировать данные через SAN сеть.
3.	Если вы используете систем хранения (СХД) для хранения файлов ВМ, вы можете воспользоваться возможностями СХД по интеграции со средствами резервного копирования (аппаратные снапшоты).
4.	Изначально гостевая ОС не знает о том, что создается ее резервная копия. Соответственно при попытке восстановить ВМ из такого бэкапа, ОС пытается продолжить свою работу с момента создания снимка. В некоторых случаях это может вызвать проблемы как с самой ОС, так и с потерей данных в запущенными внутри нее приложениях (особенно в транзакционных, таких как Exchange, SQL, ADDS и т.п.). Для преодоления этой проблемы в Hyper-V 2016 появился новый тип снимков — Production Checkpoints (Microsoft рекомендуется применять обычные снимки — Standard Checkpoint только в тестовых и лабораторных средах, или для бэкапа остановленных виртуальных машин);
5.	Для работы Production Checkpoints в гостевой ОС средств должны быть установлены компоненты интеграции Hyper-V, и включена служба Volume Shadow Copy (Windows) или заморозки файловой системы fsfreeze (Linux). Однако состоянии памяти при этом не копируется. Т.е. Hyper-V уведомляет гостевую ОС о создании снимка, приложение с поддержкой VSS корректно завершает текущие транзакции, переходит в консистентное состояние и создает снимок ВМ. При восстановлении из такого снимка гостевая ОС выключена (т.к. состояние памяти не сохранялось), после включения она считает, что просто произошло аварийное отключение по питанию. Приложение (если оно поддерживает VSS) при этом начинает работу с сохранённого согласованного состояния.
6.	Для экономии места на устройстве хранении резервной копий рекомендуется использовать дедупликацию. Если вы используете дифференциальные диски, нужно чтобы средство резервного копирования поддерживало эту технологию. Иначе вы можете хранить одинаковые данные ВМ несколько раз.
7.	При большой плотности виртуальных машин на хосте желательно иметь возможность планирования времени резервного копирования ВМ, чтобы избежать чрезвычайно нагрузки на продуктивные системы в производственное время.
8.	Если вам нужно хранить несколько копий виртуальной машины, нужно обеспечить управление количеством хранимых копий ВМ.
9.	Настройте мониторинг СРК и устройства хранения резервных копий. Не хочется в определенных момент узнать, то резервное копирование не работает, т.к. на СХД под бэкапы закончилось место. Здесь же нужно вспомнить про средство верификации резервных копий.
10.	Некоторые СРК поддерживают гранулярное восстановление отдельных файлов/папок без необходимости развёртывания целиком ВМ или ее виртуального диска.
Примечание. Многие СРК позволяют, например, восстановления конкретные хранилища, ящики и даже отдельных писем из резервной копии ВМ с Exchange Server.
11.	СРК должна позволять настраивать права доступа к системе за счет ролевой модели управления резервным копированием.
12.	Реализуйте классическую стратегию резервного копирования 3-2-1 (три копии, на двух разных носителях, один из которых на другой площадке).  
Управление виртуальными машинами Hyper-V
Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart
Get-VMHost| select LogicalProcessorCount, MemoryCapacity
Set-VMHost -VirtualMachinePath D:\VM -VirtualHardDiskPath 'D:\VM\VHD'
New-VMSwitch -Name "ExtVMSwitch" -AllowManagementOS $True -NetAdapterName Ethernet0 -SwitchType External

$VMName = "spb-dmz2"
$VM = @{
Name = $VMName
MemoryStartupBytes = 1Gb
Generation = 2
NewVHDPath = "C:\HV\$VMName\$VMName.vhdx"
NewVHDSizeBytes = 5Gb
BootDevice = "VHD"
Path = "C:\HV\$VMName"
SwitchName = "ExtVMSwitch"
}
New-VM @VM
vmconnect.exe localhost spb-app01
