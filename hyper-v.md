Зеркалирование портов в Hyper-V
Зеркалирование портов можно использовать в системах на базе Hyper-V для поиска неисправностей в сети, тестирования, мониторинга, анализа сетевого трафика и перенаправления трафика на анализ в IDS системы (системы обнаружения вторжений
Set-VMNetworkAdapter –VMName VMWin2008Source –PortMirroring Source

Set-VMNetworkAdapter –VMName VMWin2008Monitor –PortMirroring Destination
**************
Как увеличить/уменьшить размер виртуального диска Hyper-V
•	Вы можете изменить размер виртуального диска Hyper-V любого типа: фиксированного, динамического, и дифференциального.
•	Вы можете изменить размер VHDX диска (в том числе системного диска гостевой ОС) на-лету. Останавливатьвиртуальную машину не нужно;
•	VHDX диск должен быть подключен к ВМ через виртуальный SCSI контролер (не поддерживается онлайн расширение дисков на IDE контроллере, такую ВМ придется выключить для изменения размера диска);
•	Online VHDX Resize работает как на первом, так и втором поколении виртуальных машин Hyper-V;
•	В качестве гостевой ОС может выступать, как Windows, так и Linux;
•	Поддерживается как расширение виртуальных дисков (extend), так и их сжатие (shrink);
•	Вы можете изменить размер vhdx диска из графической консоли Hyper-V, PowerShell или Windows Admin Center;
•	Не поддерживается изменение размера общих VHDX файлов или VHD Set (VHDS/AVHDX) дисков, используемых в гостевых кластерах;
•	Нельзя изменить размер виртуального диска, для которого создан снапшот (например при резервном копировании).
Get-VM -VMName fs01 | Select-Object VMId | Get-VHD
Resize-VHD -Path 'C:\VM\fs01\Virtual Hard Disks\fs01.vhdx' -SizeBytes 50Gb
Enter-PSSession -ComputerName fs01
$MaxSize = (Get-PartitionSupportedSize -DriveLetter C).SizeMax
Resize-Partition -DriveLetter L -Size $MaxSize
************
Списки контроля доступа порта в Hyper-V
Стандартные ACL появились в 3 версии гипервизора в Windows Server 2012. С их помощью можно для каждого порта виртуального коммутатора настроить одно или несколько правил, ограничив доступ к виртуальной машине по IP или MAC-адресу.
Настройки ACL производятся исключительно с помощью PowerShell, управление списками через Hyper-V Manager невозможно. Для создания правила используется командлет Add-VMNetworkAdapterAcl, в качестве объекта применения правила можно указать виртуальную машину, либо, если у машины несколько сетевых интерфейсов, то можно выбрать конкретный виртуальный адаптер. Для каждого списка требуется указать:
• Локальный или удаленный IPv4 или IPV6-адрес. Допускается указывать подсеть, например 192.168.1.0/24 или f001:f002:f003:f004::1/64. Для запрета всего IPv4 трафика можно указать 0.0.0.0/0, для запрета всего IPV6 — ::/0, а указав ANY, мы запрещаем любой трафик;
• Локальный или удаленный MAC-адрес, например 00-ab-00-11-22-33. Также можно использовать символ *(wildcard) либо ANY для указания всех MAC-адресов;
• Направление трафика, подпадающего под правило — входящий (Inbound), исходящий (Outbound), в обе стороны (Both);
• Действие — разрешить (Allow), запретить (Deny), измерить (Meter).
Примечание. Действие Meter не является запрещающим или разрешающим, оно служит исключительно для измерения объема трафика для конкретного IP-адреса. Трафик считается с момента создания правила.
Для примера запретим  для виртуальной машины srv3 весь трафик:
Add-VMNetworkAdapterAcl -VMName srv3 -RemoteIPAddress ANY -Direction Both -Action Deny
И проверим получившееся правило командой:
Get-VMNetworkAdapterAcl
Начиная с Windows Server 2012 R2 для управления трафиком в Hyper-V можно использовать расширенные списки доступа (Extended Port ACL). Также как и обычные ACL, их можно применять к виртуальным машинам или отдельным виртуальным сетевым адаптерам, подключенным к виртуальному коммутатору Hyper-V. Однако расширенные ACL имеют большее количество параметров, чем обычные, что дает возможность создавать более подробные правила.
Так расширенные ACL позволяют не просто разрешать или запрещать весь трафик, но и указывать конкретные протоколы и порты. При создании правила с использованием расширенных ACL можно указывать следующий набор параметров:
• Локальный или удаленный IPv4 или IPV6-адрес. Формат записи такой же, как и для стандартных правил;
• Сетевой протокол. Протокол можно указывать как в текстовом виде, напр. TCP или UDP, так и в цифровом, напр. 0x01 (ICMP) или 0x02 (IGMP). Список кодов можно посмотреть здесь;
• Локальный или удаленный порт;
• Направление трафика, подпадающего под правило — входящий (Inbound) или исходящий (Outbound);
• Действие — разрешить (Allow), запретить (Deny);
• Удельный вес правила (Weight), который определяет порядок обработки правил. Правила с более высокими значениями обрабатываются раньше, чем с более низкими. Например, правило с весом 10 будет обработано раньше, чем правило с весом 1.
Создание и управление расширенными ACL также возможно только из консоли PowerShell. Для создания правила используется командлет Add-VMNetworkAdapterExtendedAcl, для просмотра  Get-VMNetworkAdapterExtendedAcl и Remove-VMNetworkAdapterExtendedAcl для удаления.
В качестве примера создадим два правила, в первом для srv3 запретим весь входящий трафик, а во втором разрешим входящие подключения только на порт 3389 (RDP):
Add-VMNetworkAdapterExtendedAcl -VMName srv3 -Direction Inbound -Action Deny -Weight 1
Add-VMNetworkAdapterExtendedAcl -VMName srv3 -Direction Inbound  -LocalPort ″3389″ -Protocol ″TCP″ -Action Allow -Weight 2

Get-VMNetworkAdapterExtendedAcl -VMName srv2 | ft direction,action,*address,*port,protocol,stateful,*timeout -auto
********
Мониторинг загрузки процессора на серверах Hyper-V
Для мониторинга загрузки процессора в Hyper-V есть три группы счетчиков:
• Hyper-V Hypervisor Logical Processor;
• Hyper-V Hypervisor Virtual Processor;
• Hyper-V Hypervisor Root Virtual Processor.
Это основная группа счетчиков Hyper-V, которая показывает нагрузку на процессор в привязке к логическим процессорам. Напомню, что под логическим процессором система понимает физические ядра процессора или вычислительные потоки (при использовании Hyper-Threading).
Hyper-V Hypervisor Logical Processor позволяет выводить как общую нагрузку (_Total), так и по каждому логическому процессору (LP) отдельно. Основные счетчики для мониторинга общей нагрузки, это:
% Guest Run Time — нагрузка на процессор, создаваемая виртуальными машинами;
% Hypervisor Run Time — нагрузка на процессор, создаваемая самим гипервизором, т.е. процент процессорного времени, которое затрачено гипервизором на обслуживание виртуальных машин;
% Total Run Time — общая нагрузка на процессор, представляет из себя сумму двух предыдущих счетчиков.
yper-V Hypervisor Virtual Processor показывает нагрузку на процессор, создаваемую виртуальными машинами. Виртуальные процессоры (VP) группируются по принадлежности к виртуальным машинам, что позволяет оценить нагрузку, создаваемую каждой отдельной машиной, а общее значение (_Total) показывает суммарную нагрузку, создаваемую гостевыми ОС.
Виртуальные процессоры имеют большое количество различных счетчиков, но основные те же, что и в предыдущем случае:
% Guest Run Time — процент процессорного времени, затраченный виртуальными машинами на собственные задачи, не связанные с гипервизором;
% Hypervisor Run Time — процент процессорного времени, затраченный виртуальными машинами на задачи, связанные с гипервизором;
% Total Run Time — общая нагрузка на процессор, создаваемая виртуальными машинами. Представляет из себя сумму двух предыдущих счетчиков.
Hyper-V Hypervisor Root Virtual Processor содержит такой же набор счетчиков, как и Hyper-V Hypervisor Virtual Processor. Отличие их в том, что Hyper-V Hypervisor Root Virtual Processor содержит счетчики только для хостовой ОС, которая работает в основном разделе (Root partition):
% Guest Run Time — процент процессорного времени, затраченный хостом на задачи, не связанные с гипервизором;
% Hypervisor Run Time — процент процессорного времени, затраченный хостовой системой на обслуживание гипервизора;
% Total Run Time — общая нагрузка на процессор, создаваемая хостовой ОС. Представляет из себя сумму предыдущих счетчиков.
**********
Определение Memory overcommit в гостевой виртуальной машине
Memory overcommit (определения на русском я не знаю, пусть будет оверкоммит памяти) это фича гипервизора, которая позволяет выделить виртуальным машинам памяти больше, чем имеется на физическом хосте, однако без гарантии того, что в конкретный момент времени вся запрошенная память может быть выделена. Как правило, overcommit позволяет увеличить плотность размещения виртуальных машин на хосте за счет того, что память будет динамически перераспределятся между ними в зависимости от текущей нагрузки (ресурсы ненагруженных/простаивающих в данный момент ВМ могут быть перераспределены между более загруженными)
Чтобы понять, что происходит с памятью, нужно воспользоваться утилитой RamMap Марка Русиновича (в одних из прошлых кейсов я показывал, как использовать эту утилиту для диагностики проблемы с системным кэшем файловой системы). Качаем утилиту с сайта Microsoft (https://technet.microsoft.com/en-us/library/ff700229.aspx) и запускаем с правами администратора. После этого, на вкладке Use Counts видим, что большая часть памяти (5,4 Гб) используется объектом Driver Locked.
Это и есть та память, которую «отъел» гипервизор и перераспределил другим виртуальным машинам через balloon-драйвер в гостевой ОС. Т.е. на хосте гипервизора не хватает памяти, либо администратор гипервизора принудительно «зарезал» ресурсы для данной ВМ.
Текущий расклад по памяти в ВМ на Hyper-V могут дать счетчики отдельные производительности в Performance Monitor:
•	Hyper-V Dynamic Memory –>Guest Visible Memory
•	Hyper-V Dynamic Memory –> Physical Memory
Чтобы отключить такое поведение, администратор гипервизора должен отключить в настройках ВМ Hyper-V опцию Enable Dynamic Memory (или увеличить значение минимальной резервации).
**********
Включаем поддержку SR-IOV для виртуальных машин Hyper-V
SR-IOV (Single Root Input/Output Virtualization) это технология виртуализации аппаратных устройств хоста, позволяющая предоставить виртуальным машинам прямой доступ к устройствам. Технология позволяет виртуализировать различные виды устройств, но чаще всего используется для виртуализации сетевых адаптеров. В этой статье мы расскажем, как правильно включить и настроить SR-IOV для сетевых адаптеров виртуальных машин на сервере Hyper-V.
Благодаря использованию SR-IOV для виртуальных машин Hyper-V вы существенно увеличите пропускную способность, снизите сетевую задержку и уменьшите нагрузку на CPU, вызванную необходимостью обрабатывать сетевой трафик программными средствами Hyper-V.
SR-IOV не совместима с NIC teaming.
В первую очередь нужно включить поддержку SR-IOV и виртуализации в BIOS вашего сервера. В зависимости от вендора и модели сервера эти настройки могут отличаться.
•	Виртуализация: Intel (Virtualization Technology, Intel VT, VT-d, Vanderpool), AMD (SVM, AMD-V)
•	IOMMU
•	SR-IOV
•	ASPM
(get-vmhost).IovSupport
(get-vmhost).IovSupportReasons

New-VMSwitch -Name "Ext_network" -NetAdapterName "Ethernet 2" -EnableIov 1

Set-VMNetworkAdapter -VMName testvm -VMNetworkAdapterName “Network Adapter” -IovWeight 100
**********